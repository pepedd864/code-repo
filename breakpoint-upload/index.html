<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<span class="status">状态：
    <span class="inner"></span>
</span><br>
<input type="file"/>
<button class="upload-btn">上传文件</button>
<button class="pause-btn">暂停上传</button>
<script src="https://cdn.bootcdn.net/ajax/libs/spark-md5/3.0.0/spark-md5.js"></script>
<script src="upload.js"></script>
<script type="module">
  const status = document.querySelector('.status .inner')
  const fileInput = document.querySelector('input[type="file"]')
  const uploadBtn = document.querySelector('button.upload-btn')
  const pauseBtn = document.querySelector('button.pause-btn')
  let cutFileInfo
  let pause = false
  fileInput.onchange = function (e) {
    status.innerHTML = '已选择文件'
    const file = e.target.files[0]
    spiltFile(file).then((res) => {
      cutFileInfo = res
      status.innerHTML = `文件已处理, 耗时${res.time}ms`
    })
  }
  uploadBtn.onclick = async function () {
    if (!cutFileInfo) {
      alert('请先选择文件或等待文件处理')
      return
    }
    status.innerHTML = '开始检查文件进度'
    const resp = await handShake()
    if (typeof resp.data === 'string') {
      status.innerHTML = `文件已上传, 链接：${resp.data}`
      return
    }
    // await 可以将异步的代码当作同步代码来执行, 所以这里实现了sleep的效果
    await new Promise(resolve => setTimeout(resolve, 1000))
    const progress = 1 - (resp.data.length / cutFileInfo.chunks.length)
    status.innerHTML = `${progress === 0 ? '文件未上传' : `已上传${(progress * 100).toFixed(2)}%`}`
    await upload(resp.data)
  }


  /**
   * 与后端握手，获取文件上传进度
   * @returns {Promise<any>}
   */
  async function handShake() {
    return await fetch('http://localhost:8000/api/upload/handshake', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        fileId: cutFileInfo.fileId,
        ext: cutFileInfo.ext,
        chunkIds: cutFileInfo.chunks.map(it => it.id)
      })
    }).then(resp => resp.json())
  }

  /**
   * 断点上传文件
   * @param needs
   * @returns {Promise<void>}
   */
  async function upload(needs) {
    // 上传文件
    await uploadPiece(
      cutFileInfo,
      needs,
      false,
      (progress) => {
        status.innerHTML = `上传进度：${progress.toFixed(2)}%`
      }, () => {
        status.innerHTML = '上传文件成功'
      }
    )
  }
</script>
</body>
</html>
